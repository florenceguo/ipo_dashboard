# 📈 板块涨跌幅图表优化说明

## 🔄 优化内容

### 从周度改为月度展示
- **之前**: 显示每周各板块的平均涨跌幅
- **现在**: 显示每月各板块的平均涨跌幅

### 智能跳过无数据月份
- **之前**: 无数据时显示为0
- **现在**: 无数据的月份直接跳过，不在图表中显示

## 🛠️ 技术实现

### ipoinfo.py 修改

1. **添加月度标签**:
```python
# 添加月度标签
ipoinfo['month_label'] = ipoinfo['listing_date'].dt.to_period('M')
```

2. **计算月度均值**:
```python
# 计算每个板块的月度平均涨跌幅
monthly_board_returns = ipoinfo.groupby(['month_label', 'ipo_board'])['pctchg'].mean().unstack()

# 只保留有实际数据的月份（剔除所有板块都为NaN的月份）
monthly_board_returns = monthly_board_returns.dropna(how='all')

# 对于每个板块，如果某个月没有数据，保持为NaN（不填充为0）
# 这样在绘图时会自动跳过这些点
```

3. **更新图表类型**:
```python
# 从柱状图改为线图，更适合趋势展示
for board in monthly_board_returns.columns:
    board_data = monthly_board_returns[board].dropna()
    if len(board_data) > 0:  # 只有当板块有数据时才绘制
        x_positions = [monthly_board_returns.index.get_loc(idx) for idx in board_data.index]
        plt.plot(x_positions, board_data.values, 'o-', label=board, linewidth=2, markersize=4)
```

### app.js 修改

1. **数据处理逻辑**:
```javascript
const data = months.map(month => {
    const monthData = rawData.find(item => (item.month_label || item.index) === month);
    const value = monthData ? monthData[sector] : null;
    // 如果值为null、undefined、NaN或0，返回null以跳过该点
    return (value !== null && value !== undefined && !isNaN(value) && value !== 0) 
        ? (value * 100) : null;
});
```

2. **图表配置**:
```javascript
spanGaps: false, // 不连接间隔点
pointRadius: data.map(val => val === null ? 0 : 4), // 隐藏null点
```

## 📊 显示效果

### 图表特点
- **线图展示**: 更清晰地显示趋势变化
- **智能跳跃**: 自动跳过无数据的月份
- **多板块对比**: 同时显示5个板块的趋势
- **交互式**: 支持悬停查看具体数值

### 数据处理
- **月度聚合**: 将同一月份的新股数据计算平均值
- **空值处理**: 某板块某月无新股时，该点不显示
- **趋势连续**: 有数据的月份之间保持连线

## 🎯 优势对比

| 特性 | 优化前 | 优化后 |
|------|--------|--------|
| **时间粒度** | 周度 | 月度 |
| **数据密度** | 密集，难以观察趋势 | 适中，趋势清晰 |
| **无数据处理** | 显示为0，误导性强 | 跳过，更准确 |
| **图表类型** | 柱状图 | 线图 |
| **趋势展示** | 不够清晰 | 非常清晰 |

## 📝 使用示例

### 数据更新后的效果
1. **运行数据更新**:
```bash
python ipoinfo.py
python analyze_excel.py
```

2. **查看网站**:
- 访问 http://localhost:8080
- 查看"各板块月度涨跌幅趋势"图表
- 观察各板块的月度表现趋势

### 实际应用场景
- **投资决策**: 观察各板块的长期趋势
- **风险评估**: 识别波动较大的板块
- **时机选择**: 找出表现较好的时间段
- **板块轮动**: 发现板块间的轮动规律

## 🔧 自定义选项

如果需要进一步调整，可以修改：

1. **时间粒度**: 改为季度聚合
```python
ipoinfo['quarter_label'] = ipoinfo['listing_date'].dt.to_period('Q')
```

2. **显示阈值**: 设置最小显示值
```python
return (value > 0.01) ? (value * 100) : null;  # 只显示>1%的涨跌幅
```

3. **板块筛选**: 只显示特定板块
```python
sectors = ['科创板', '创业板']  # 只显示这两个板块
```

现在板块涨跌幅图表更加直观和准确了！📈✨

